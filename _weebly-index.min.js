"use strict";function putInStat(e,t){stat.style.color=t,stat.value=e}function checkForm(){if(!form||ins.some(e=>!e))return err(str.malfunc),window.location.reload(!0),!1;for(let e of ins)e.focus();return form.checkValidity()?parseInt(byId("id").value)%13==11||(byId("id").focus(),err(str.invstid),!1):(err(str.invinpt),!1)}function submitData(e){const t=ins.reduce((e,t)=>(e[t.id]=t.value.trim().toLowerCase(),e),{});return postFetch(e,t)}function excelDate(e){let t;if(e>60)t=25568;else{if(!(e>0&&e<60))return e.toString();t=25567}let n=new Date(86400*(e-t)*1e3);return`${n.getMonth()+1}/${n.getDate()}/${n.getFullYear()}`}function dateRange(e){let t=e.replace(/\s/g,"").split("-"),n=t.map(e=>{let t=e.split("/");return 3===t.length&&2===t[2].length&&(t[2]=`20${t[2]}`),t.join("/")});return n.join(" - ")}function parseResponse(e){for(let t of outs)t.value=numFormat(e[t.id]);const t=e.data,n=document.createElement("table"),r=document.createElement("thead");let a=document.createElement("tr");for(let e of["Date","Event","S","L","F"]){let t=document.createElement("th"),n=document.createTextNode(e);t.appendChild(n),a.appendChild(t)}r.appendChild(a),n.appendChild(r);const o=document.createElement("tbody");for(let e of t){let t,n=document.createElement("tr");t="number"==typeof e.date?excelDate(e.date):dateRegex.test(e.date)?dateRange(e.date):e.date;let r=document.createElement("td"),a=document.createTextNode(t);r.appendChild(a),n.appendChild(r),r=document.createElement("td"),a=document.createTextNode(e.evnt),r.appendChild(a),n.appendChild(r);for(let t of[e.serv,e.lead,e.fell])r=document.createElement("td"),t&&(a=document.createTextNode(numFormat(t)),r.appendChild(a)),n.appendChild(r);o.appendChild(n)}n.appendChild(o),tblDiv.appendChild(n),suc(str.success)}function search(){for(let e of outs)e.value="";for(;tblDiv.lastChild;)tblDiv.removeChild(tblDiv.lastChild);if(checkForm()){war(str.loading);for(let e of outs)e.value=str.checkin;submitData(`http://${ip}/php/search.php`).then(e=>{if(200===e.status)return e.json();err("Internal Error!")}).then((e={stat:99})=>{for(let e of outs)e.value="";switch(e.stat){case-1:return void err(str.notfond);case-2:return void err(str.reqerrr);case-3:return void err(str.updatin);case 0:return void parseResponse(e);default:return void err(str.interrr)}}).catch(errCon)}}function time(){getFetch(`http://${ip}/php/search.php`).then(e=>{if(200===e.status)return e.text();errCon()}).then(e=>{if(null!=e){suc(str.testres+e);for(let e of ins)e.disabled=!1;submit.disabled=!1,submit.addEventListener("click",e=>{e.preventDefault(),search()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),search())}),byId("fname").focus()}}).catch(errCon)}function init(){war(str.testing),getFetch(ipUrl).then(e=>{if(200===e.status)return e.text();errCon()}).then(e=>{ip=`${e.trim()}:38080`,time()}).catch(errCon)}const str={timeout:"Connection failure! Please retry in a few moments...",testres:"Data updated at ",malfunc:"Webpage malfunction! Reloading...",invinpt:"Invalid input!",invstid:"You may have mistyped your student ID. Please double check.",success:"Success",loading:"Searching data, please wait...",checkin:"Checking...",notfond:"Name-ID combination not found!",reqerrr:"Request error!",updatin:"Server is updating data. Please retry in a few moments...",interrr:"Internal error!",testing:"Looking for server, please wait..."};var ip;const ipUrl="https://mushinako.github.io/Check-Hours/ip.txt";var phpUrl;const dateRegex=/^\d{1,2}\/\d{1,2}\/\d{2,4}\s*\-\s*\d{1,2}\/\d{1,2}\/\d{2,4}$/,byId=e=>document.getElementById(e),inputsFromIds=e=>e.map(e=>byId(e)),tblDiv=byId("data"),form=byId("input"),submit=byId("submit"),stat=byId("stat"),ins=inputsFromIds(["fname","lname","id","pass"]),outs=inputsFromIds(["serv","lead","fell"]),suc=e=>putInStat(e,"#1b5e20"),war=e=>putInStat(e,"#f57f17"),err=e=>putInStat(e,"#d50000"),errCon=()=>err(str.timeout),numFormat=e=>(Math.round(100*e)/100).toFixed(2),getFetch=e=>fetch(e,{method:"GET"}),postFetch=(e,t)=>fetch(e,{method:"POST",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:Object.entries(t).map(([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&")});document.addEventListener("DOMContentLoaded",()=>{let e=["  ___________  ____   ___    _______ ______"," / ___/ __/ / / / /  / _ )  / ___/ //_/  _/","/ /___\\ \\/ /_/ / /__/ _  | / /__/ ,< _/ /","\\___/___/\\____/____/____/  \\___/_/|_/___/",""," Bug Reports Welcomed!"];console.log(e.join("\n")),init()});